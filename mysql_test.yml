- name: change root temporary password
  hosts: mysql80
  become: yes
  tasks:
    - name: get root password
      shell: "grep 'temporary password' /var/log/mysqld.log | sed -s 's/.*root@localhost: //'"
      register: root_password
      changed_when: False

    - name: update temporary root password
      command: mysql --user root --password={{ root_password.stdout }} --connect-expired-password --execute="alter user 'root'@'localhost' identified by 'MySQL8.0';"
      register: change_root_result
      changed_when: "change_root_result.rc == 0 and 'Access Dinied' not in change_root_result.stderr"
      failed_when: False
    
    - name: debug result
      debug:
        msg: "{{ change_root_result }}"
